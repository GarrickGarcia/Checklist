<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Claude Feature Tracker</title>
  <!-- React 18 + ReactDOM 18 -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <!-- Babel for JSX (no build needed) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Papa Parse for robust CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" integrity="sha512-eG6X8I7eA3kK3Y9tL0f3cV3sN8WJ3h9NDn5qU3gT5kGQnU+Rr6j0sQGkZl7qI4jY7bWq+Hlf9f9r0p1xQkJpGg==" crossorigin="anonymous"></script>
  <style>
    /* (optional) subtle body reset to match your inline styles nicely */
    html, body { margin: 0; background: #F0EEE6; }
    button { font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const ClaudeFeatureTracker = () => {
      const teamMembers = ['Garrick', 'Kelly', 'Clay', 'Justin', 'Joe'];

      const features = [
        { name: 'Model Picker',          subFeatures: [] },
        { name: 'Extended Thinking',     subFeatures: [] },
        { name: 'Research',              subFeatures: [] },
        { name: 'Data Analysis',         subFeatures: [] },
        { name: 'File Editing/Creation', subFeatures: [] },
        { name: 'Artifacts',             subFeatures: [] },
        { name: 'Projects',              subFeatures: [] },
        { name: 'Connectors',            subFeatures: [] },
        { name: 'MCP',                   subFeatures: [] }
      ];

      // Endpoints you already set up
      const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZQyaCne0_O69riTMC5pFDypMv-ivMZ_ZGSY4pbui9T-8kZZF-LdamW70yfhU-nvYu68r4KC2Gfuvc/pub?gid=0&single=true&output=csv";
      const WEBHOOK = "https://hook.us1.make.com/usjpboqndhxk3iopws1q9vew14gudfcy";

      // Initialize completion state (same shape you had)
      const initializeState = () => {
        const state = {};
        teamMembers.forEach(member => {
          state[member] = {};
          features.forEach(feature => {
            if (feature.subFeatures.length > 0) {
              state[member][feature.name] = {};
              feature.subFeatures.forEach(subFeature => {
                state[member][feature.name][subFeature] = false;
              });
            } else {
              state[member][feature.name] = false;
            }
          });
        });
        return state;
      };

      const [completionStatus, setCompletionStatus] = useState(initializeState);
      const [isLoading, setIsLoading] = useState(true);
      const [isSaving, setIsSaving] = useState(false);
      const [lastSaved, setLastSaved] = useState(null);
      const [loadedBatchTs, setLoadedBatchTs] = useState(null);

      // Load latest snapshot from the published Sheet CSV
      const loadFromSheet = async () => {
        setIsLoading(true);
        console.log('Loading from Google Sheets CSV...');
        try {
          // cache-bust to avoid stale CSV
          const url = `${CSV_URL}&t=${Date.now()}`;
          const text = await fetch(url, { cache: "no-store" }).then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);
            return r.text();
          });

          const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
          const rows = parsed.data || [];
          console.log('Parsed rows:', rows.length);

          if (!rows.length) {
            setCompletionStatus(initializeState());
            setLoadedBatchTs(null);
            return;
          }

          // Find latest batch_ts
          const latestTs = rows.reduce((max, row) => row.batch_ts > max ? row.batch_ts : max, "");
          const latest = rows.filter(row => row.batch_ts === latestTs);

          const newState = initializeState();
          latest.forEach(row => {
            const featureName = row.Feature;
            if (!featureName) return;
            teamMembers.forEach(member => {
              const val = (row[member] || "").trim();
              newState[member][featureName] = /^done$/i.test(val);
            });
          });

          setCompletionStatus(newState);
          setLoadedBatchTs(latestTs);
          console.log('Loaded batch:', latestTs);
        } catch (err) {
          console.error('CSV load failed:', err);
        } finally {
          setIsLoading(false);
        }
      };

      // Save current snapshot via Make (append-only, one POST per row)
      const saveSnapshot = async () => {
        setIsSaving(true);
        const batch_ts = new Date().toISOString();

        // Build rows from current state
        const rows = features.map(feature => {
          const row = { batch_ts, Feature: feature.name };
          teamMembers.forEach(member => {
            row[member] = completionStatus[member][feature.name] ? "Done" : "Not Done";
          });
          return row;
        });

        // Small concurrency for speed without hammering
        const postRow = async (row, attempt = 0) => {
          try {
            const res = await fetch(WEBHOOK, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(row),
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
          } catch (e) {
            if (attempt < 2) {
              await new Promise(r => setTimeout(r, 500 * (attempt + 1)));
              return postRow(row, attempt + 1);
            }
            throw e;
          }
        };

        try {
          const chunk = 3;
          for (let i = 0; i < rows.length; i += chunk) {
            await Promise.all(rows.slice(i, i + chunk).map(postRow));
          }
          setLastSaved(new Date());
          console.log('All rows saved.');
        } catch (e) {
          console.error('Save failed:', e);
        } finally {
          setIsSaving(false);
        }
      };

      // On mount, load latest from the Sheet
      useEffect(() => { loadFromSheet(); }, []);

      const toggleCompletion = (member, feature, subFeature = null) => {
        setCompletionStatus(prev => ({
          ...prev,
          [member]: {
            ...prev[member],
            [feature]: subFeature
              ? {
                  ...prev[member][feature],
                  [subFeature]: !prev[member][feature][subFeature]
                }
              : !prev[member][feature]
          }
        }));
      };

      const getCompletionCount = () => {
        let totalTasks = 0;
        let completedTasks = 0;
        teamMembers.forEach(member => {
          features.forEach(feature => {
            if (feature.subFeatures.length > 0) {
              feature.subFeatures.forEach(subFeature => {
                totalTasks++;
                if (completionStatus[member][feature.name][subFeature]) completedTasks++;
              });
            } else {
              totalTasks++;
              if (completionStatus[member][feature.name]) completedTasks++;
            }
          });
        });
        return { completed: completedTasks, total: totalTasks };
      };

      const { completed, total } = getCompletionCount();
      const progressPercentage = Math.round((completed / total) * 100);

      return (
        <div style={{
          backgroundColor: '#F0EEE6',
          color: '#141413',
          minHeight: '100vh',
          padding: '32px',
          fontFamily: 'system-ui, -apple-system, sans-serif',
          position: 'relative'
        }}>
          {/* Loading Overlay */}
          {isLoading && (
            <div style={{
              position: 'fixed',
              top: 0, left: 0, right: 0, bottom: 0,
              backgroundColor: 'rgba(240, 238, 230, 0.9)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000
            }}>
              <div style={{
                backgroundColor: '#E3DACC',
                padding: '24px 48px',
                borderRadius: '12px',
                textAlign: 'center'
              }}>
                <div style={{ fontSize: '18px', fontWeight: '500', marginBottom: '8px' }}>
                  Loading from Google Sheets...
                </div>
                <div style={{ fontSize: '14px', opacity: 0.7 }}>
                  Please wait while we fetch your team's progress
                </div>
              </div>
            </div>
          )}

          <div style={{ maxWidth: '1200px', margin: '0 auto' }}>
            {/* Header */}
            <div style={{ marginBottom: '32px', textAlign: 'center' }}>
              <h1 style={{
                fontSize: '28px',
                fontWeight: '600',
                margin: '0 0 8px 0',
                color: '#141413'
              }}>
                Claude Feature Tracker
              </h1>
              <p style={{
                fontSize: '16px',
                margin: '0 0 16px 0',
                opacity: 0.7
              }}>
                Track your team's progress testing Claude ecosystem features
              </p>
              <div style={{
                backgroundColor: '#E3DACC',
                padding: '12px 24px',
                borderRadius: '8px',
                display: 'inline-block'
              }}>
                <span style={{ fontSize: '16px', fontWeight: '500' }}>
                  Progress: {completed}/{total} ({progressPercentage}%)
                </span>
              </div>

              {/* Save and Status Controls */}
              <div style={{
                marginTop: '16px',
                display: 'flex',
                gap: '12px',
                justifyContent: 'center',
                alignItems: 'center',
                flexWrap: 'wrap'
              }}>
                <button
                  onClick={saveSnapshot}
                  disabled={isSaving}
                  style={{
                    backgroundColor: isSaving ? '#CEC6B9' : '#D97757',
                    color: isSaving ? '#141413' : 'white',
                    border: 'none',
                    borderRadius: '6px',
                    padding: '10px 20px',
                    fontSize: '14px',
                    fontWeight: '500',
                    cursor: isSaving ? 'not-allowed' : 'pointer',
                    transition: 'all 0.2s ease'
                  }}
                >
                  {isSaving ? 'Saving...' : 'Save Changes'}
                </button>

                <button
                  onClick={loadFromSheet}
                  disabled={isLoading}
                  style={{
                    backgroundColor: '#CEC6B9',
                    color: '#141413',
                    border: 'none',
                    borderRadius: '6px',
                    padding: '10px 20px',
                    fontSize: '14px',
                    fontWeight: '500',
                    cursor: isLoading ? 'not-allowed' : 'pointer',
                    transition: 'all 0.2s ease'
                  }}
                >
                  {isLoading ? 'Loading...' : 'Refresh Data'}
                </button>

                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px' }}>
                  {lastSaved && (
                    <span style={{ fontSize: '12px', opacity: 0.7 }}>
                      Last saved: {lastSaved.toLocaleTimeString()}
                    </span>
                  )}
                  {loadedBatchTs && (
                    <span style={{ fontSize: '11px', opacity: 0.5 }}>
                      Data from: {new Date(loadedBatchTs).toLocaleString()}
                    </span>
                  )}
                </div>
              </div>
            </div>

            {/* Main Table */}
            <div style={{
              backgroundColor: '#E3DACC',
              borderRadius: '12px',
              padding: '24px',
              boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
            }}>
              <div style={{ overflowX: 'auto' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                  <thead>
                    <tr>
                      <th style={{
                        padding: '16px 12px',
                        textAlign: 'left',
                        fontWeight: '600',
                        fontSize: '14px',
                        borderBottom: '2px solid '#CEC6B9',
                        backgroundColor: '#CEC6B9'
                      }}>
                        Feature
                      </th>
                      {teamMembers.map(member => (
                        <th key={member} style={{
                          padding: '16px 12px',
                          textAlign: 'center',
                          fontWeight: '600',
                          fontSize: '14px',
                          borderBottom: '2px solid #CEC6B9',
                          minWidth: '120px',
                          backgroundColor: '#CEC6B9'
                        }}>
                          {member}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {features.map(feature => (
                      <React.Fragment key={feature.name}>
                        {/* Main feature row */}
                        {feature.subFeatures.length === 0 && (
                          <tr>
                            <td style={{
                              padding: '12px',
                              fontWeight: '500',
                              borderBottom: '1px solid #CEC6B9'
                            }}>
                              {feature.name}
                            </td>
                            {teamMembers.map(member => (
                              <td key={member} style={{
                                padding: '12px',
                                textAlign: 'center',
                                borderBottom: '1px solid #CEC6B9'
                              }}>
                                <button
                                  onClick={() => toggleCompletion(member, feature.name)}
                                  style={{
                                    backgroundColor: completionStatus[member][feature.name] ? '#D97757' : '#CEC6B9',
                                    color: completionStatus[member][feature.name] ? 'white' : '#141413',
                                    border: 'none',
                                    borderRadius: '6px',
                                    padding: '8px 16px',
                                    fontSize: '12px',
                                    fontWeight: '500',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s ease',
                                    minWidth: '80px'
                                  }}
                                >
                                  {completionStatus[member][feature.name] ? 'Done' : 'Not Done'}
                                </button>
                              </td>
                            ))}
                          </tr>
                        )}
                        {/* If you add subfeatures later, this block remains compatible */}
                        {feature.subFeatures.length > 0 && (
                          <>
                            <tr>
                              <td style={{
                                padding: '12px',
                                fontWeight: '600',
                                fontSize: '15px',
                                borderBottom: '1px solid #CEC6B9'
                              }}>
                                {feature.name}
                              </td>
                              {teamMembers.map(member => (
                                <td key={member} style={{
                                  padding: '12px',
                                  borderBottom: '1px solid #CEC6B9'
                                }}></td>
                              ))}
                            </tr>
                            {feature.subFeatures.map(subFeature => (
                              <tr key={subFeature}>
                                <td style={{
                                  padding: '12px 24px',
                                  fontSize: '14px',
                                  borderBottom: '1px solid #CEC6B9',
                                  fontStyle: 'italic'
                                }}>
                                  • {subFeature}
                                </td>
                                {teamMembers.map(member => (
                                  <td key={member} style={{
                                    padding: '12px',
                                    textAlign: 'center',
                                    borderBottom: '1px solid #CEC6B9'
                                  }}>
                                    <button
                                      onClick={() => toggleCompletion(member, feature.name, subFeature)}
                                      style={{
                                        backgroundColor: completionStatus[member][feature.name][subFeature] ? '#D97757' : '#CEC6B9',
                                        color: completionStatus[member][feature.name][subFeature] ? 'white' : '#141413',
                                        border: 'none',
                                        borderRadius: '6px',
                                        padding: '8px 16px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s ease',
                                        minWidth: '80px'
                                      }}
                                    >
                                      {completionStatus[member][feature.name][subFeature] ? 'Done' : 'Not Done'}
                                    </button>
                                  </td>
                                ))}
                              </tr>
                            ))}
                          </>
                        )}
                      </React.Fragment>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Footer Note */}
            <div style={{
              marginTop: '24px',
              textAlign: 'center',
              fontSize: '14px',
              opacity: 0.6
            }}>
              Data is synchronized with Google Sheets (read) and Make (write). Use "Save Changes" to persist your updates.
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<ClaudeFeatureTracker />);
  </script>
</body>
</html>
